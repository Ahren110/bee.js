//component as directive
var utils = require('../utils.js');
var domUtils = require('../dom-utils')
var checkBinding = require('../check-binding')

module.exports = {
  priority: -1
, watch: false
, unLink: function() {
    this.component && this.component.$destroy()
  }
, link: function() {
    var vm = this.vm;
    var el = this.el;
    var cstr = vm.constructor;
    var comp;
    var dirs, $data = {};
    var Comp = cstr.getComponent(this.path)

    if(Comp) {

      //直接 `Bee.mount` 一个组件
      if(Comp === cstr && vm.__mountcall || el.bee && el.bee === vm) {
        return;
      }

      dirs = this.dirs.filter(function (dir) {
        return dir.type == 'attr' || dir.type == 'with';
      });

      dirs.forEach(function (dir) {
        var curPath, comPath;

        curPath = dir.path;
        if(dir.type === 'with') {
          //comPath = '$data'
          utils.extend($data, vm.$get(curPath))
        }else{
          comPath = utils.hyphenToCamel(dir.dirName);
          $data[comPath] = vm.$get(curPath);
        }

        //监听父组件更新, 同步数据
        vm.$watch(curPath, function (val) {
          if(comp){
            val = dir.textMap ? dir.textMap.join('') : val;
            comPath ? comp.$set(comPath, val) : comp.$set(val);
          }
        })
      });

      //组件内容属于其容器
      vm.__links = vm.__links.concat(checkBinding.walk.call(vm, el.childNodes));

      this.component = comp = new Comp({
        $el: el,
        $isReplace: true,
        
        $data: utils.extend(true, {}, $data, domUtils.getAttrs(el))
      });
      el.bee = comp;

      return comp;
    }else{
      console.error('Component: ' + this.path + ' not defined!');
    }
  }
};
